<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<title>üöÄ Rocket Mining Chat</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #4e9fff, #6ac9ff);
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column; 
    }
    .chat-title {
        text-align: center;
        padding: 15px;
        background: #333;
        color: white;
        font-size: 18px;
        font-weight: bold;
        flex-shrink: 0; 
    }
    .chat-container {
        flex-grow: 1; 
        display: flex;
        flex-direction: column;
        padding: 10px;
        max-width: 600px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box; 
    }
    /* Xabarlar ro'yxati joylashuvi */
    #chat-messages {
        flex-grow: 1;
        background: #f8f8f8;
        border-radius: 12px 12px 0 0;
        padding: 15px;
        list-style: none;
        overflow-y: auto;
        margin: 0;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
    }
    /* Xabarlar stili (avvalgi kabi) */
    .message-bubble {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        max-width: 85%;
        position: relative;
    }
    .message-content {
        padding: 10px 15px;
        border-radius: 18px;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-image {
        /* Base64 katta bo'lishi mumkin, max kenglik qo'yish yaxshi */
        max-width: 100%; 
        height: auto;
        border-radius: 10px;
        margin-top: 5px;
    }
    .message-user {
        font-size: 11px;
        color: #555;
        margin-bottom: 3px;
        display: flex;
        align-items: center;
    }
    .verified-icon {
        width: 20px;
        height: 20px;
        margin-left: 5px;
    }
    .message-mine {
        align-self: flex-end;
    }
    .message-mine .message-content {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }
    .message-mine .message-user {
        text-align: right;
        color: #e0e0e0;
    }
    .message-mine .message-user .verified-icon {
        order: 2; 
        margin-left: 0;
        margin-right: 5px;
    }
    .message-other {
        align-self: flex-start;
    }
    .message-other .message-content {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
    }
    .message-admin {
        align-self: flex-start;
    }
    .message-admin .message-content {
        background: #ffaa00;
        color: white;
        font-weight: bold;
        border-bottom-left-radius: 4px;
    }
    .message-admin .message-user {
        color: #cc8000;
    }
    .reply-block {
        background: rgba(0, 0, 0, 0.05);
        border-left: 3px solid #007bff;
        padding: 5px 10px;
        border-radius: 4px;
        margin-bottom: 5px;
        font-size: 13px;
        color: #666;
        max-height: 50px;
        overflow: hidden;
        text-overflow: ellipsis; 
    }
    .message-mine .reply-block {
        border-left: 3px solid #00c16e;
        color: #ddd;
        background: rgba(255, 255, 255, 0.1);
    }
    .reply-btn {
        position: absolute;
        top: 0;
        right: -30px;
        background: transparent;
        border: none;
        color: #555;
        font-size: 16px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
        padding: 5px;
    }
    .message-mine .reply-btn {
        left: -30px;
        right: auto;
    }
    .reply-btn:hover {
        opacity: 1;
    }
    /* Input maydoni */
    .chat-input-container {
        flex-shrink: 0; 
        display: flex;
        flex-direction: column;
        padding: 10px;
        background: white;
        border-top: 1px solid #ddd;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .replying-to-indicator {
        display: none;
        background: #f0f0f0;
        padding: 8px 10px;
        border-left: 4px solid #007bff;
        font-size: 13px;
        color: #333;
        margin: 0 0 10px 0;
        border-radius: 4px;
        position: relative;
    }
    .replying-to-indicator.active {
        display: block;
    }
    .clear-reply-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #999;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
    }
    .chat-input {
        display: flex;
        align-items: center;
    }
    
    /* FAYL TANLASH TUGMASI STILI */
    #image-select-btn {
        background: #ccc;
        color: #333;
        border: none;
        border-radius: 20px;
        padding: 10px 10px; 
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-right: 10px;
        flex-shrink: 0;
    }
    #image-select-btn:hover {
        background: #bbb;
    }
    #image-file-input {
        display: none;
    }
    
    #message-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 12px;
        margin-right: 5px; 
    }
    
    /* YUBORISH TUGMASINI TO'G'RILASH */
    #send-btn {
        background: #00c16e;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        min-width: 80px; 
        flex-shrink: 0;
    }
    #send-btn:active {
        background: #00a25e;
    }
    #send-btn:disabled { 
        opacity: 0.6;
        cursor: not-allowed;
    }
    /* ======================================= */
    
    /* PROGRESS BAR STILI (Endi faqat yuklanish indikatori) */
    .image-indicator {
        font-size: 12px;
        color: #007bff;
        margin-top: 0;
        margin-bottom: 5px;
        display: flex; 
        justify-content: space-between; 
        align-items: center;
    }
    #upload-percent {
        font-weight: bold;
    }
    .progress-bar {
        /* RTDB uchun progress bar keraksiz, shuning uchun yashiriladi */
        display: none !important; 
    }
    /* ================================= */

    .back-btn {
        position: fixed; 
        top: 15px; 
        left: 10px;
        padding: 10px 20px;
        background: #f0f0f0;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1000; 
    }
    .blocked-message {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: #cc0000;
        font-size: 20px;
        font-weight: bold;
        padding: 20px;
        background: #ffe6e6;
        border-radius: 12px;
        margin: 20px;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }
    
    /* === LIVE CHAT STYLING (Yangi qo'shildi) === */
    .live-stream-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #333;
        color: white;
        border-radius: 12px 12px 0 0;
        margin-top: 10px;
    }
    .live-stream-header button {
        padding: 8px 15px;
        border: none;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
    }
    #go-live-btn {
        background: #ff4d4d;
        color: white;
    }
    #go-live-btn:hover {
        background: #e60000;
    }
    #join-live-btn {
        background: #00c16e;
        color: white;
        display: none; /* Dastlab yashiriladi */
    }
    #join-live-btn:hover {
        background: #00a25e;
    }
    #live-indicator {
        font-size: 14px;
        color: #ff4d4d;
        font-weight: bold;
        animation: pulse 1s infinite;
        display: none;
    }
    @keyframes pulse {
        0% { opacity: 0.8; }
        50% { opacity: 1; }
        100% { opacity: 0.8; }
    }
    /* ======================================= */
</style>
</head>
<body>

<div class="chat-title">
    üöÄ Umumiy Chat
</div>

<div id="chat-content" class="chat-container">
    
    <div class="live-stream-header">
        <span id="live-indicator">üî¥ LIVE</span>
        <div id="live-controls">
            <button id="join-live-btn" onclick="joinLiveStream()">Jonli efirga qo'shilish</button>
            <button id="go-live-btn" onclick="startLiveStream()">Jonli efirni boshlash</button>
        </div>
    </div>
    <ul id="chat-messages">
        </ul>
    
    <div class="chat-input-container">
        <div class="replying-to-indicator" id="reply-indicator">
            Javob: <span id="reply-text"></span> 
            <button class="clear-reply-btn" onclick="clearReply()">‚úñ</button>
        </div>
        
        <div id="image-upload-indicator" class="image-indicator" style="display: none;">
            Rasm tanlandi: <span id="image-file-name"></span>
            </div>
        
        <div class="chat-input">
            <input type="file" id="image-file-input" accept="image/*" onchange="displayFileName()">
            <button id="image-select-btn" onclick="document.getElementById('image-file-input').click()">üîó</button>
            <input type="text" id="message-input" placeholder="Write a message..." onkeyup="checkEnter(event)">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<div id="blocked-content" class="blocked-message" style="display: none;">
    ‚ùå You have been blocked from this chat..
</div>

<button class="back-btn" onclick="location.href='index.html'">Back</button>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, push, onValue, serverTimestamp, query, limitToLast, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
// Firebase Storage importlari olib tashlandi.

// === FIREBASE KONFIGURATSIYASI ===
// Konfiguratsiyani o'zgartiring!
const firebaseConfig = {
  apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
  authDomain: "user1111-c84a0.firebaseapp.com",
  databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
  projectId: "user1111-c84a0",
  storageBucket: "user1111-c84a0.firebaseapp.com",
  messagingSenderId: "901723757936",
  appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
  measurementId: "G-9R8ZQY63B1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
// const storage = getStorage(app); // Storage o'chirildi
const chatRef = ref(db, 'chats/global_chat'); 
const blockedRef = ref(db, 'blocked_users');

// === YAXSHILANGAN ONLINE/LIVE REF'LAR QO'SHILDI ===
const liveStreamRef = ref(db, 'live_stream/current_stream');
const onlineUsersRef = ref(db, 'online_users'); // Online foydalanuvchilar ro'yxati

// Device ID ni olish (asosiy ilovadagi kabi)
let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "user_"+Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}
const currentUsername = deviceId.substring(0, 8); // Foydalanuvchi nomi

// === ONLINE HOLATINI BOSHQARISH (QO'SHILDI) ===
const userOnlineRef = ref(db, `online_users/${deviceId}`);

// Ulanish uzilganda foydalanuvchini online ro'yxatidan olib tashlash
onDisconnect(userOnlineRef).remove();

// Foydalanuvchini online ro'yxatiga qo'shish
set(userOnlineRef, {
    username: currentUsername,
    last_seen: serverTimestamp()
});

// === BLOKLANISH HOLATI ===
let isUserBlocked = false;

function checkBlockStatus(blockedUsersSnapshot) {
    const blockedList = blockedUsersSnapshot.val();
    const isBlockedNow = blockedList && blockedList.hasOwnProperty(deviceId);

    if (isBlockedNow && !isUserBlocked) {
        isUserBlocked = true;
        document.getElementById('chat-content').style.display = 'none';
        document.getElementById('blocked-content').style.display = 'flex';
    } else if (!isBlockedNow && isUserBlocked) {
        isUserBlocked = false;
        document.getElementById('chat-content').style.display = 'flex';
        document.getElementById('blocked-content').style.display = 'none';
    } else if (!isUserBlocked) {
        document.getElementById('chat-content').style.display = 'flex';
        document.getElementById('blocked-content').style.display = 'none';
    }
}

onValue(blockedRef, (snapshot) => {
    checkBlockStatus(snapshot);
});

// === LIVE STREAM MANTIQI (QO'SHILDI) ===

let currentLiveStreamer = null;

onValue(liveStreamRef, (snapshot) => {
    const liveData = snapshot.val();
    const joinBtn = document.getElementById('join-live-btn');
    const goLiveBtn = document.getElementById('go-live-btn');
    const liveIndicator = document.getElementById('live-indicator');
    
    // Hozirgi efir tugadi
    if (!liveData) {
        currentLiveStreamer = null;
        liveIndicator.style.display = 'none';
        joinBtn.style.display = 'none';
        goLiveBtn.innerText = "Jonli efirni boshlash";
        goLiveBtn.disabled = false;
        return;
    }
    
    currentLiveStreamer = liveData.user_id;
    const streamerUsername = liveData.username;
    liveIndicator.style.display = 'inline';
    
    // Foydalanuvchi o'zi efir qilayotgan bo'lsa
    if (currentLiveStreamer === deviceId) {
        goLiveBtn.innerText = "Efirni tugatish (LIVE)";
        goLiveBtn.disabled = false;
        joinBtn.style.display = 'none';
        liveIndicator.innerHTML = `üî¥ LIVE: Siz efirdasiz`;
        
        // Agar o'zi efir qilayotgan bo'lsa, ulanish uzilganda efirni ham o'chirsin
        onDisconnect(liveStreamRef).remove();

    } 
    // Boshqa birov efir qilayotgan bo'lsa
    else {
        liveIndicator.innerHTML = `üî¥ LIVE: ${streamerUsername}`;
        goLiveBtn.innerText = "Jonli efirni boshlash";
        goLiveBtn.disabled = true; // Boshqa birov efirda bo'lsa boshlay olmasin
        joinBtn.style.display = 'inline';
        
        // O'zidan oldingi onDisconnectni olib tashlash kerak (agar o'zi boshlagan bo'lsa)
        // Shuning uchun, bu yerda onDisconnect funksiyasini qayta chaqirish orqali uni o'chira olmaymiz, 
        // Lekin agar oldin efir qilmagan bo'lsa muammo yo'q.
    }
});


window.startLiveStream = function() {
    if (isUserBlocked) return;
    
    if (currentLiveStreamer === deviceId) {
        // Efirni tugatish
        remove(liveStreamRef)
            .then(() => alert("Jonli efir tugatildi."))
            .catch(error => console.error("Efirni tugatishda xato:", error));
    } else {
        // Yangi efirni boshlash
        const liveData = {
            user_id: deviceId,
            username: currentUsername,
            start_time: serverTimestamp(),
            // WebRTC uchun kerakli boshqa ma'lumotlar bu yerga qo'shilishi mumkin (masalan, session ID)
        };
        
        set(liveStreamRef, liveData)
            .then(() => alert("Jonli efir boshlandi! Eslatma: Haqiqiy video/audio stream uchun WebRTC integratsiyasi talab qilinadi."))
            .catch(error => console.error("Efirni boshlashda xato:", error));
    }
}

window.joinLiveStream = function() {
    if (isUserBlocked) return;
    
    if (currentLiveStreamer) {
        alert(`Siz hozir ${currentLiveStreamer} tomonidan boshlangan jonli efirga qo'shildingiz!
        
        ESLATMA: Haqiqiy WebRTC ulanish o'rnatilishi va videoni ko'rish uchun qo'shimcha JavaScript kodi va WebRTC serverlari kerak bo'ladi.`);
        
        // **!!! BU YERDA HAQIQIY WEBRTC ULANISH MANTIQI BO'LISHI KERAK !!!**
    } else {
        alert("Hozirda faol jonli efir mavjud emas.");
    }
}

// === CONSTANTS ===
const VERIFIED_ICON_URL = "galochka.png";

// === Rasm tanlanganligini ko'rsatish funksiyasi ===
window.displayFileName = function() {
    const fileInput = document.getElementById('image-file-input');
    const indicator = document.getElementById('image-upload-indicator');
    const fileNameSpan = document.getElementById('image-file-name');
    

    if (fileInput.files.length > 0) {
        fileNameSpan.innerText = fileInput.files[0].name;
        indicator.style.display = 'flex';
    } else {
        fileNameSpan.innerText = '';
        indicator.style.display = 'none';
    }
}

// === REPLY FUNKSIYALARI ===
window.setReply = function(id, text) {
    if (isUserBlocked) return;
    
    replyingToId = id;
    replyingToText = text;
    document.getElementById('reply-text').innerText = text.substring(0, 50) + (text.length > 50 ? '...' : '');
    document.getElementById('reply-indicator').classList.add('active');
    document.getElementById('message-input').focus();
}

window.clearReply = function() {
    replyingToId = null;
    replyingToText = null;
    document.getElementById('reply-text').innerText = '';
    document.getElementById('reply-indicator').classList.remove('active');
}

// === CHAT MANTIQI ===
function renderMessage(key, message, isMine) {
    const chatMessagesEl = document.getElementById('chat-messages');
    
    if (document.getElementById(`msg-${key}`)) return;

    const li = document.createElement('li');
    li.classList.add('message-bubble');
    li.id = `msg-${key}`;
    
    let usernameDisplay;
    let bubbleClass;

    if (message.isAdmin) {
        const adminNik = message.username || "admin";
        usernameDisplay = `${adminNik} <img src="${VERIFIED_ICON_URL}" alt="Verified" class="verified-icon">`;
        bubbleClass = 'message-admin';
    } else if (isMine) {
        usernameDisplay = message.username || deviceId.substring(0, 8);
        bubbleClass = 'message-mine';
    } else {
        usernameDisplay = message.username || "Anonim";
        bubbleClass = 'message-other';
    }

    li.classList.add(bubbleClass);
    
    let replyHtml = '';
    if (message.replyToText) {
        replyHtml = `<div class="reply-block">Javob berilgan: ${message.replyToText.substring(0, 40) + (message.replyToText.length > 40 ? '...' : '')}</div>`;
    }
    
    let imageHtml = '';
    // ENDI message.imageUrl emas, message.imageBase64Data tekshiriladi
    if (message.imageBase64Data) {
        // Base64 ma'lumotini to'g'ridan-to'g'ri src ga berish
        imageHtml = `<img src="${message.imageBase64Data}" class="message-image" alt="Yuborilgan rasm">`;
    }

    const messageContent = message.text || (message.imageBase64Data ? '' : '...');

    li.innerHTML = `
        <button class="reply-btn" onclick="setReply('${key}', '${messageContent.replace(/'/g, "\\'")}')">‚Ü™</button>
        ${replyHtml}
        <span class="message-user">${usernameDisplay}</span>
        <div class="message-content">
            ${message.text ? message.text : ''} ${imageHtml}
        </div>
    `;

    chatMessagesEl.appendChild(li);
}


// === RASMNI BASE64 GA O'TKAZISH FUNKSIYASI (Realtime Database uchun) ===
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) {
            return resolve(null);
        }
        
        // Realtime Database ning 10MB limitini hisobga olgan holda maksimal 7MB rasmga ruxsat berish.
        const MAX_FILE_SIZE = 7 * 1024 * 1024; 
        if (file.size > MAX_FILE_SIZE) {
            reject(new Error("Fayl juda katta (Maks. 7MB). Realtime Database katta hajmdagi fayllarni qo'llab-quvvatlamaydi. Iltimos, kichikroq rasm tanlang."));
            return;
        }

        const reader = new FileReader();
        reader.onload = () => resolve(reader.result); // Base64 ma'lumotini qaytaradi
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file); // Faylni Base64 Data URL formatida o'qish
    });
}


// Xabar yuborish
window.sendMessage = async function() {
    if (isUserBlocked) {
        alert("Siz bloklangansiz va xabar yubora olmaysiz.");
        return;
    }
    
    const inputEl = document.getElementById('message-input');
    const imageInputEl = document.getElementById('image-file-input');
    const messageText = inputEl.value.trim();
    const imageFile = imageInputEl.files[0];

    if (messageText === "" && !imageFile) return;

    let base64Data = null; // Yangi o'zgaruvchi Base64 ma'lumotni saqlaydi
    const sendBtn = document.getElementById('send-btn');
    
    if (imageFile) {
        
        sendBtn.disabled = true; // Rasm Base64 ga o'tkazilayotganda tugmani o'chirish
        
        try {
            // Rasm faylini Base64 formatida o'qish
            base64Data = await fileToBase64(imageFile);
            
        } catch (error) {
            alert(error.message); // Fayl hajmi limiti yoki o'qish xatosi
            sendBtn.disabled = false;
            return; 
        }
    }
    
    // Agar Base64 konversiyasi muvaffaqiyatli bo'lsa yoki matn mavjud bo'lsa, xabarni yuborish
    const newMessage = {
        user_id: deviceId, 
        username: currentUsername, // currentUsername dan foydalanish
        text: messageText,
        // Base64 ma'lumotini saqlash
        imageBase64Data: base64Data, 
        timestamp: serverTimestamp(),
        isAdmin: false,
        replyToId: replyingToId,
        replyToText: replyingToText
    };

    push(chatRef, newMessage)
        .then(() => {
            inputEl.value = '';
            imageInputEl.value = '';
            window.displayFileName(); // Indikatorni tozalash
            clearReply();
            sendBtn.disabled = false;
        })
        .catch(error => {
            console.error("Xabar yuborishda xato:", error);
            alert("Xabar yuborilmadi. Internet yoki Realtime Database qoidalari bilan muammo (Xatolikni brauzer konsolida tekshiring).");
            sendBtn.disabled = false;
        });
};

// Enter tugmasi bilan yuborish
window.checkEnter = function(event) {
    if (event.key === "Enter" && !document.getElementById('send-btn').disabled) {
        sendMessage();
    }
}

// Xabarlarni tinglash (Real-time)
const messagesQuery = query(chatRef, limitToLast(100));

onValue(messagesQuery, (snapshot) => {
    if (isUserBlocked) return; 

    const chatMessagesEl = document.getElementById('chat-messages');
    
    // Scroll holatini saqlash (eng pastga yaqin bo'lsa avtomatik tushadi)
    const shouldScroll = chatMessagesEl.scrollTop + chatMessagesEl.clientHeight >= chatMessagesEl.scrollHeight - 50;

    // Xabarlarni tozalash 
    chatMessagesEl.innerHTML = ''; 

    snapshot.forEach((childSnapshot) => {
        const messageKey = childSnapshot.key;
        const message = childSnapshot.val();
        const isMine = message.user_id === deviceId && !message.isAdmin; 
        renderMessage(messageKey, message, isMine);
    });
    
    // Foydalanuvchi eng pastda bo'lsa, pastga tushadi
    if (shouldScroll) {
         chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
});

// Sahifa yuklanganda bloklanganlik holatini tekshirish uchun barcha kontentni yashiramiz
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('chat-content').style.display = 'none';
});
</script>

</body>
</html>
