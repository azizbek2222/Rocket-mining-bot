<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>Tasks - Rocket Mining</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #4e9fff, #6ac9ff);
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            color: #333;
        }
        
        .back-btn {
        position: absolute; top: 4px; left: 20px;
        margin-top: 15px;
        padding: 10px 20px;
        background: #f0f0f0;
        color: #007bff;
        border: 1px solid #007bff;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: #007bff;
            margin-bottom: 20px;
            text-align: center;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .task-title {
            font-size: 18px;
            font-weight: bold;
            color: #000;
            margin-bottom: 5px;
        }

        .task-details {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .task-details span {
            font-weight: bold;
            color: #28a745;
        }

        .task-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #28a745, #00c16e);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }
        
        /* Vazifani Boshlash tugmasi */
        .task-btn.start {
            background: linear-gradient(45deg, #007bff, #00a2ff); /* Ko'k rangda qoldirdik */
        }

        /* Tasdiqlash tugmasi */
        .task-btn.confirm {
            background: linear-gradient(45deg, #28a745, #00c16e);
        }

        /* Bajarilgan tugmasi */
        .task-btn.completed {
            background: #6c757d; /* Kulrang */
            cursor: not-allowed;
        }
        
        .task-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .task-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .task-timer {
            /* Taymerni yashirish */
            display: none; 
        }
        
        /* Oldingi 'task-link' stili kerak emas
        .task-link {
            display: none; 
        }
        */
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸš€ Mavjud vazifalar</h2>
    <ul class="task-list" id="task-list">
        <li style="text-align: center; color: #666;">Vazifalar yuklanmoqda...</li>
    </ul>
    <p id="no-tasks" style="text-align: center; display: none; color: #666;">Hozirda hech qanday vazifa mavjud emas. Keyinroq tekshiring!</p>
</div>
<button class="back-btn" onclick="location.href='index.html'">Orqaga</button>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// === FIREBASE KONFIGURATSIYASI ===
const firebaseConfig = {
  apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
  authDomain: "user1111-c84a0.firebaseapp.com",
  databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
  projectId: "user1111-c84a0",
  storageBucket: "user1111-c84a0.firebaseapp.com",
  messagingSenderId: "901723757936",
  appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
  measurementId: "G-9R8ZQY63B1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "user_"+Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}

const taskListEl = document.getElementById("task-list");
const noTasksEl = document.getElementById("no-tasks");

let completedTasks = {}; // Foydalanuvchi bajarilgan vazifalari

// Foydalanuvchi ma'lumotlarini (balans, bajarilgan vazifalarni) yuklash
async function loadUserData() {
    try {
        const snapshot = await get(child(dbRef, "users/" + deviceId));
        if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.completed_tasks) {
                completedTasks = userData.completed_tasks;
            }
            return userData.balance || 0.00;
        }
    } catch (error) {
        console.error("Error fetching user data:", error);
    }
    return 0.00;
}

// Vazifalarni Firebase'dan yuklash
async function loadTasks() {
    taskListEl.innerHTML = '<li style="text-align: center; color: #666;">Vazifalar yuklanmoqda...</li>';
    noTasksEl.style.display = 'none';
    
    // 1. Foydalanuvchi ma'lumotlarini yuklash (qaysi vazifalar bajarilganini bilish uchun)
    await loadUserData(); 

    try {
        const snapshot = await get(child(dbRef, "tasks"));
        if (snapshot.exists()) {
            const tasks = snapshot.val();
            const taskKeys = Object.keys(tasks);
            
            taskListEl.innerHTML = ''; 
            let tasksDisplayed = 0;

            taskKeys.forEach(key => {
                const task = tasks[key];
                
                // 2. Agar vazifa bajarilmagan bo'lsa, ko'rsatish
                if (!completedTasks[key]) {
                    displayTask(key, task);
                    tasksDisplayed++;
                }
            });
            
            if (tasksDisplayed === 0) {
                noTasksEl.style.display = 'block';
            }

        } else {
            taskListEl.innerHTML = '';
            noTasksEl.style.display = 'block';
        }
    } catch (error) {
        console.error("Error loading tasks:", error);
        taskListEl.innerHTML = '<li style="text-align: center; color: #ff5722;">Error loading tasks.</li>';
    }
}

// Har bir vazifani HTMLda ko'rsatish
function displayTask(taskId, task) {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.id = `task-${taskId}`;
    
    li.innerHTML = `
        <div class="task-title">${task.name}</div>
        <div class="task-details">Reward: <span>${task.reward} â‚½</span></div>
        <div class="task-details">Wait Time: <span>${task.wait_time} seconds</span></div>
        <button class="task-btn start" data-task-id="${taskId}" data-url="${task.url || ''}" onclick="startTask('${taskId}', ${task.wait_time}, ${task.reward})">Vazifani boshlash</button>
        `;
    taskListEl.appendChild(li);
}

// Vazifani boshlash mantiqi (URL ga o'tish va taymerni boshlash)
window.startTask = function(taskId, waitTime, reward) {
    const taskItem = document.getElementById(`task-${taskId}`);
    const startBtn = taskItem.querySelector('.task-btn');
    const taskUrl = startBtn.getAttribute('data-url');
    
    // 1. Agar URL mavjud bo'lsa, havolaga o'tish
    if (taskUrl) {
        window.open(taskUrl, '_blank');
    }

    startBtn.disabled = true;
    startBtn.innerText = "Processing...";
    startBtn.classList.remove('start');
    
    // 2. Tasdiqlash vaqtini hisobga olish (foydalanuvchiga ko'rsatmasdan)
    // Foydalanuvchi tugmani bosgan vaqt
    const startTime = Date.now(); 

    // 3. Tasdiqlash tugmasini ko'rsatish (Sekund sanash yo'q)
    startBtn.innerText = "Vazifaning bajarilishini tasdiqlang";
    startBtn.disabled = false;
    startBtn.classList.add('confirm');
    
    // Tasdiqlash funksiyasini yangilash
    startBtn.onclick = () => confirmTask(taskId, reward, waitTime, startTime);
};

// Vazifani tasdiqlash va balansni yangilash
async function confirmTask(taskId, reward, requiredWaitTime, startTime) {
    const taskItem = document.getElementById(`task-${taskId}`);
    const confirmBtn = taskItem.querySelector('.task-btn');

    confirmBtn.disabled = true;
    confirmBtn.innerText = "Processing...";

    // 1. Kutish vaqtini tekshirish
    const timeElapsed = (Date.now() - startTime) / 1000; // Sekunddagi farq
    
    if (timeElapsed < requiredWaitTime) {
        // Agar yetarli vaqt o'tmagan bo'lsa
        const remaining = Math.ceil(requiredWaitTime - timeElapsed);
        alert(`Please wait ${remaining} more seconds to confirm the task.`);
        
        // Tugmani eski holatiga qaytarish (qayta boshlashga majbur qilish)
        confirmBtn.innerText = "Task Failed. Try Again (Start)";
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('confirm');
        confirmBtn.classList.add('start');
        confirmBtn.onclick = () => startTask(taskId, requiredWaitTime, reward);
        return;
    }
    
    // 2. Balansni yangilash
    let currentBalance = await loadUserData(); // Eng yangi balansni olish
    const newBalance = currentBalance + reward;
    
    try {
        // Balans va bajarilgan vazifalarni Firebase'ga yozish (Atomik update emas, ammo soddalik uchun)
        await update(ref(db, "users/" + deviceId), { 
            balance: newBalance,
            [`completed_tasks/${taskId}`]: Date.now()
        });
        
        // 3. Foydalanuvchi interfeysini yangilash: Bajarilgan deb belgilash
        confirmBtn.innerText = `+${reward.toFixed(2)} â‚½ Added! (Completed)`;
        confirmBtn.classList.remove('confirm');
        confirmBtn.classList.add('completed');
        
        // 4. Vazifani ro'yxatdan olib tashlash
        taskItem.remove(); 
        
        alert(`Task "${taskId}" completed successfully! ${reward.toFixed(2)} â‚½ added to your balance.`);

    } catch (error) {
        console.error("Error confirming task and updating balance:", error);
        confirmBtn.innerText = "Error. Try again.";
        confirmBtn.disabled = false;
        confirmBtn.classList.remove('completed');
    }
    
    // Barcha vazifalar bajarilganligini tekshirish
    if (taskListEl.children.length === 0) {
        noTasksEl.style.display = 'block';
    }
}

// Sahifa yuklanganda vazifalarni yuklash
window.onload = loadTasks;
</script>

</body>
</html>