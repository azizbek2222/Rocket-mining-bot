<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta charset="UTF-8">
<title>Auto Rocket Mining - Avtomatik Qazib Olish</title>

<style>
/* ========================================================== */
/* ========= AUTO MINING FUTURISTIK KO'RINISH STILI ========= */
/* ========================================================== */

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    /* Asosiy fonni chuqur koinot rangiga o'zgartirish */
    background: #0d0d1e; /* Chuqur ko'k-qora koinot */
    color: #e0f7fa; /* Matn rangini yorqin oq/och ko'k qilish */
    text-align: center;
    padding: 0;
    margin: 0;
    overflow-x: hidden;
    min-height: 100vh;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* Kontentni yuqori va pastga bo'lish */
}

/* Yulduzlar animatsiyasi uchun stil - Index sahifasidagi kabi */
.star-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 0; 
}

/* Kichik va o'rta yulduzlar */
.star-layer::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(1.5px 1.5px at 20% 30%, #fff, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 90% 40%, #c4e4ff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 15% 80%, #a4c4f0, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 70% 10%, #fff, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 50% 50%, #fff, rgba(0,0,0,0));
    animation: starfield 120s linear infinite;
    background-size: 500px 500px;
}

/* Kattaroq va tezroq harakatlanuvchi yulduzlar */
.star-layer::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(2px 2px at 40% 10%, #fffeff, rgba(0,0,0,0)),
                radial-gradient(2.5px 2.5px at 10% 20%, #c5e6ff, rgba(0,0,0,0));

    animation: starfield 60s linear infinite reverse;
    background-size: 600px 600px;
}

@keyframes starfield {
    from { background-position: 0 0; }
    to { background-position: 100% 100%; }
}

/* === Asosiy Kontent === */
.main-content {
    z-index: 10;
    padding: 20px;
    max-width: 400px;
    width: 100%;
    margin: 0 auto;
    flex-grow: 1; 
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 25px;
}

/* Balans Qutisi (Index'dagi kabi ko'rinishga yaqin) */
.balance-display {
    background: #1a237e; /* To'q ko'k fon */
    padding: 15px 25px;
    border-radius: 15px;
    box-shadow: 0 0 15px #4fc3f7, 0 0 30px rgba(79, 195, 247, 0.4); /* Yorqin ko'k soya */
    border: 2px solid #4fc3f7;
    width: 90%;
}
.balance-title {
    font-size: 14px;
    color: #bbdefb;
    text-transform: uppercase;
    margin-bottom: 5px;
}
.balance-value {
    font-size: 28px;
    font-weight: bold;
    color: #a7ffeb; /* Neon yashil-ko'k rang */
    text-shadow: 0 0 10px rgba(167, 255, 235, 0.7);
}


/* Avtominer Status Bloki */
.miner-status-box {
    background: rgba(30, 40, 90, 0.7); /* Shaffof to'q ko'k */
    padding: 20px;
    border-radius: 15px;
    border: 1px solid #7c4dff; /* Binafsha chegara */
    box-shadow: 0 0 15px rgba(124, 77, 255, 0.5); /* Binafsha soya */
    width: 90%;
}
.status-title {
    font-size: 16px;
    color: #ffcc00; /* Oltin rang */
    margin-bottom: 10px;
    font-weight: 600;
}
.status-value {
    font-size: 24px;
    font-weight: bold;
    color: #00ff88; /* Yashil */
    min-height: 25px; /* Bo'sh turmasligi uchun */
}


/* Mining Pul/Reklama Taymeri */
.mining-progress-box {
    margin-top: 15px;
    background: rgba(0, 0, 0, 0.4);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #3a75b7;
    width: 90%;
}
.progress-title {
    font-size: 13px;
    color: #bbdefb;
    margin-bottom: 5px;
}
.progress-value {
    font-size: 18px;
    font-weight: bold;
    color: #ff5722; /* To'q sariq */
}

/* Yenggi qo'shilgan Global Stats Bloki */
.global-stats-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(20, 50, 80, 0.7);
    padding: 15px;
    border-radius: 15px;
    border: 1px solid #ffeb3b; /* Sariq chegara */
    box-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
    width: 90%;
}
.stat-item {
    flex-basis: 48%; /* Ikki ustun uchun joylashuv */
    text-align: center;
}
.stat-title {
    font-size: 12px;
    color: #e0f7fa;
    margin-bottom: 3px;
    text-transform: uppercase;
}
.stat-value {
    font-size: 18px;
    font-weight: bold;
    color: #ffeb3b; /* Yorqin sariq */
}


/* Asosiy Tugma */
.toggle-btn {
    padding: 18px 35px;
    background: linear-gradient(45deg, #00d2ff, #007bff); /* Neon ko'k gradient */
    color: white;
    border: none;
    border-radius: 15px;
    font-size: 20px;
    font-weight: bold;
    box-shadow: 0 0 25px rgba(0, 210, 255, 0.9), 0 5px 15px rgba(0, 0, 0, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    width: 90%;
    max-width: 350px;
}
.toggle-btn:hover {
    background: linear-gradient(45deg, #007bff, #00d2ff);
    transform: translateY(-2px);
}
.toggle-btn:active {
    transform: translateY(0);
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
}

/* Faol holat uchun rang */
.toggle-btn.mining-active {
    background: linear-gradient(45deg, #4CAF50, #8bc34a); /* Yashil gradient */
    box-shadow: 0 0 25px rgba(76, 175, 80, 0.9), 0 5px 15px rgba(0, 0, 0, 0.5);
}

/* === PASTKI NAVIGATSIYA STILI (INDEX.HTML'DAN O'XSHASH) === */
.bottom-nav {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
    position: sticky; /* Sticky holatda turishi */
    bottom: 0;
    left: 0;
    background: rgba(13, 13, 30, 0.95); 
    box-shadow: 0 -5px 20px rgba(58, 117, 183, 0.4);
    padding: 8px 0;
    box-sizing: border-box;
    z-index: 20;
    border-top: 2px solid #3a75b7;
}
.bottom-nav button {
    flex-grow: 1;
    padding: 10px 5px;
    border: none;
    border-radius: 8px;
    font-size: 11px; 
    font-weight: bold;
    transition: transform 0.2s, box-shadow 0.2s;
    margin: 0 3px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.bottom-nav button:active {
    transform: scale(0.95);
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
}
.withdraw-btn { 
    background: linear-gradient(45deg, #00c16e, #00ff8e); 
    color: #111; 
}
.tasks-btn { 
    background: linear-gradient(45deg, #ffaa00, #ffeb3b); 
    color: #111; 
}
.referral-btn { 
    background: linear-gradient(45deg, #8A2BE2, #b39ddb); 
    color: white; 
}
.leaderboard-btn { 
    background: linear-gradient(45deg, #FFD700, #ffff8d); 
    color: #333; 
}
.games-btn { 
    background: linear-gradient(45deg, #FF5722, #ff8a65); 
    color: white; 
    /* Joriy sahifani belgilash uchun */
    box-shadow: 0 0 10px #ffeb3b; 
    border: 2px solid #ffeb3b;
}

</style>

</head>
<body>

<div class="star-layer"></div>

<div class="main-content">
    
    <div class="global-stats-box">
        <div class="stat-item">
            <div class="stat-title">Online People üßë‚ÄçüöÄ</div>
            <div class="stat-value" id="online-users-count">...</div>
        </div>
        <div class="stat-item">
            <div class="stat-title">Total Mined USD ‚õèÔ∏è</div>
            <div class="stat-value" id="total-mined-usd">...</div>
        </div>
    </div>
    
    <div class="balance-display">
        <div class="balance-title">Current Balance</div>
        <div class="balance-value" id="balance-value">Loading...</div>
    </div>
    
    <button class="toggle-btn" id="mining-toggle-btn" onclick="toggleMining()">
        Start Auto Mining üöÄ
    </button>
    
    <div class="miner-status-box">
        <div class="status-title">Auto Mining Status</div>
        <div class="status-value" id="mining-status">Stopped</div>
        
        <div class="mining-progress-box">
            <div class="progress-title">Next Ad Trigger</div>
            <div class="progress-value" id="progress-value">0.000000 / 0.000100 USDT</div>
        </div>
    </div>
    
</div>

<div class="bottom-nav">
    <button class="withdraw-btn" onclick="location.href='withdraw.html'">üí∞ withdraw</button>
    <button class="tasks-btn" onclick="location.href='task.html'">‚úÖ tasks</button>
    <button class="referral-btn" onclick="location.href='referal.html'">üë§ referal</button>
    <button class="leaderboard-btn" onclick="location.href='reyting.html'">üèÜ rating</button>
    <button class="games-btn" onclick="location.href='index.html'">üè† Main Page</button>
</div>


<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>
<script type="module">
// ==========================================================
// === XAVFSIZLIK CHEKLOVI: FAQAT TELEGRAM MINI APP UCHUN ===
// ==========================================================
// window.Telegram.WebApp mavjudligini tekshirish
if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initData) {
    // Agar Telegram Web App muhitida bo'lmasa, butun sahifani bloklaymiz
    document.body.innerHTML = `
        <div style="
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a0b33; color: #ffeb3b; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; padding: 20px; z-index: 100;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        ">
            <h1 style="color: #ff5722;">‚õî ACCESS DENIED ‚õî</h1>
            <p style="font-size: 18px;">This feature is only available within the official Telegram Mini Application.</p>
            <p style="font-size: 14px; color: #bbdefb;">Iltimos, ushbu funksiyadan faqat Telegram Mini App ichida foydalaning.</p>
        </div>
    `;
    // Keyingi kodni ishga tushirishni to'xtatish
    throw new Error("Access denied: Not running in Telegram Web App.");
}
// ==========================================================
// === CHEKLOV YAKUNLANDI. FAQAT TMA DA ISHlayDI. ===
// ==========================================================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
// onValue va set qo'shildi
import { getDatabase, ref, get, child, update, onValue, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// === FIREBASE KONFIGURATSIYASI (Index.html dagi bilan bir xil) ===
const firebaseConfig = {
  apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
  authDomain: "user1111-c84a0.firebaseapp.com",
  databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
  projectId: "user1111-c84a0",
  storageBucket: "user1111-c84a0.appspot.com",
  messagingSenderId: "901723757936",
  appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
  measurementId: "G-9R8ZQY63B1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "user_"+Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}

// === AVTO MINING KONSTANTALARI ===
const MINING_REWARD_PER_SECOND = 0.00001; // 1 sekundda $0.00001
const AD_TRIGGER_AMOUNT = 0.00010;       // $0.00010 yig'ilganda reklama
const MINING_INTERVAL_MS = 1000;         // Har 1 sekundda yangilash

let currentBalance = 0;
let miningInterval = null;
let earnedSinceLastAd = 0; // Reklamadan keyin yig'ilgan pul
let isMiningPausedForAd = false; // Mining reklama uchun to'xtatilganmi

// === GLOBAL STATS O'ZGARUVCHILARI ===
let totalMined = 0; // Jami ishlangan pulni saqlash
let onlineUsers = 0; // Online foydalanuvchilar soni

// === DOM ELEMENTLARI ===
const balanceValueEl = document.getElementById("balance-value");
const miningToggleBtn = document.getElementById("mining-toggle-btn");
const miningStatusEl = document.getElementById("mining-status");
const progressValueEl = document.getElementById("progress-value");
// Global Stats elementlari
const onlineUsersCountEl = document.getElementById("online-users-count");
const totalMinedUsdEl = document.getElementById("total-mined-usd");


let AdController = null; 

// === ADSGRAM FUNKSIYALARI ===
function initializeAdsgram() {
    if (window.Adsgram && !AdController) {
        // Index.html dagi blok IDsi bilan ishga tushirish
        AdController = window.Adsgram.init({blockId:"int-18645"}); 
        console.log("Adsgram muvaffaqiyatli ishga tushirildi.");
    } else if (!AdController) {
         setTimeout(initializeAdsgram, 1000); 
    }
}

/**
 * Reklamani ko'rsatadi va uning tugashini kutadi.
 * @returns {Promise<boolean>} Reklama muvaffaqiyatli ko'rsatilsa/tugasa true, aks holda false.
 */
async function showAd() {
    if (!window.Adsgram || !AdController) {
        console.error("Adsgram ishga tushirilmagan (Brauzer rejimida).");
        // FIX: Agar Adsgram mexanizmi ishlamasa, FALSE qaytaramiz.
        miningStatusEl.innerText = "Ad Service Unavailable ‚ùå"; 
        miningStatusEl.style.color = "#ff5722"; 
        isMiningPausedForAd = false; // Aslida to'xtatilmagan, shunchaki ishga tushmadi
        return false; 
    }
    
    // Miningni to'xtatish (agar ishlayotgan bo'lsa)
    stopMining(false); 
    isMiningPausedForAd = true; // Reklama uchun to'xtatilgan deb belgilaymiz

    miningStatusEl.innerText = "Ad is showing... üì∫";
    miningStatusEl.style.color = "#ffcc00"; // Sariq rang
    
    try {
        await AdController.show();
        console.log("Reklama muvaffaqiyatli ko'rsatildi.");
        return true; // Muvaffaqiyat
    } catch (err) { 
        console.error("Reklama ko'rsatishda xatolik yoki foydalanuvchi o'tkazib yubordi:", err);
        // Reklama serveri xatosi yoki foydalanuvchi yopgan bo'lsa ham (real appda davom ettirish uchun)
        return true; 
    } finally {
        isMiningPausedForAd = false; // Reklama jarayoni tugadi
    }
}
// =============================

// === MINING LOGIKASI ===

async function updateMining() {
    // Agar reklama uchun to'xtatilgan bo'lsa, pul qo'shilmaydi
    if (isMiningPausedForAd) {
        return; 
    }
    
    // 1. Pulni qo'shish
    earnedSinceLastAd += MINING_REWARD_PER_SECOND;
    currentBalance += MINING_REWARD_PER_SECOND;
    totalMined += MINING_REWARD_PER_SECOND; 
    
    // 2. Ekranni yangilash
    balanceValueEl.innerText = currentBalance.toFixed(6) + " usdt";
    progressValueEl.innerText = `${earnedSinceLastAd.toFixed(6)} / ${AD_TRIGGER_AMOUNT.toFixed(6)} USDT`;
    totalMinedUsdEl.innerText = totalMined.toFixed(4) + " $";

    // 3. Reklama triggerini tekshirish
    if (earnedSinceLastAd >= AD_TRIGGER_AMOUNT) {
        
        // **Muhim:** Reklama chiqishi kerak bo'lgan pul miqdori yig'ildi.
        // Miningni to'xtatish va pulni saqlash.
        stopMining(false); // Avtomatik to'xtatish (userInitiated=false)
        
        miningStatusEl.innerText = "Reward reached! Saving balance... üí∞";
        
        // Pulni Firebase'ga saqlash (shaxsiy balans va global stat)
        await saveBalanceToFirebase();
        
        // Reklamani ko'rsatish funksiyasini chaqirish
        const adShown = await showAd(); 
        
        // Reklama tugagandan so'ng (muvaffaqiyatli yoki muvaffaqiyatsiz)
        if (adShown) {
            earnedSinceLastAd = 0; // Hisoblagichni 0 ga qaytarish
            progressValueEl.innerText = `${earnedSinceLastAd.toFixed(6)} / ${AD_TRIGGER_AMOUNT.toFixed(6)} USDT`;

            // Miningni avtomatik davom ettirish
            startMining();
        } else {
             // FIX: Agar showAd() FALSE qaytarsa (ya'ni, brauzerda yoki xizmat mavjud bo'lmasa)
             // miningni qayta ishga tushirmaymiz.
             miningStatusEl.innerText = "Ad failed. Click Start to retry. ‚ö†Ô∏è";
             miningStatusEl.style.color = "#ffeb3b"; // Sariq rang
             // earnedSinceLastAd bu yerda saqlanib qoladi, keyingi urinishda yana saqlanadi
        }
    }
}


function startMining() {
    if (miningInterval) return; 

    // Har bir sekundda yangilash
    miningInterval = setInterval(updateMining, MINING_INTERVAL_MS);
    
    // Foydalanuvchi online holatini saqlash
    set(ref(db, "online_users/" + deviceId), true);

    // Interfeysni yangilash
    miningToggleBtn.innerText = "Stop Auto Mining ‚è∏Ô∏è";
    miningToggleBtn.classList.add("mining-active");
    miningStatusEl.innerText = "Mining in progress... ‚ú®";
    miningStatusEl.style.color = "#00ff88"; // Yashil
}

/**
 * Miningni to'xtatadi.
 * @param {boolean} userInitiated - Agar true bo'lsa, foydalanuvchi tugmani bosib to'xtatgan.
 */
function stopMining(userInitiated = true) {
    if (miningInterval) {
        clearInterval(miningInterval);
        miningInterval = null;
    }
    
    // Foydalanuvchi online holatini o'chirish (faqat foydalanuvchi tugmani bossa)
    if (userInitiated) {
        set(ref(db, "online_users/" + deviceId), null);
    }


    // Interfeysni yangilash
    miningToggleBtn.innerText = "Start Auto Mining üöÄ";
    miningToggleBtn.classList.remove("mining-active");
    miningStatusEl.innerText = userInitiated ? "Stopped by user" : "Paused for Ad";
    miningStatusEl.style.color = userInitiated ? "#e0f7fa" : "#ffcc00"; // Oq yoki Sariq
}

window.toggleMining = function() {
    if (miningInterval) {
        stopMining(true); // Foydalanuvchi tomonidan to'xtatildi
        
        // Mining to'xtatilganda qolgan pulni saqlash
        if (earnedSinceLastAd > 0) {
            saveBalanceToFirebase().then(() => {
                 alert(`Mining stopped. ${earnedSinceLastAd.toFixed(6)} USDT added to your balance.`);
                 earnedSinceLastAd = 0; 
                 progressValueEl.innerText = `${earnedSinceLastAd.toFixed(6)} / ${AD_TRIGGER_AMOUNT.toFixed(6)} USDT`;
            });
        }
    } else {
        startMining();
    }
};

// === FIREBASE MULOQOTI ===

function listenForGlobalStats() {
    // Online Users
    onValue(ref(db, "online_users"), (snapshot) => {
        onlineUsers = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        onlineUsersCountEl.innerText = onlineUsers;
    });
    
    // Total Mined USD
    onValue(ref(db, "stats/total_mined_usd"), (snapshot) => {
        if (snapshot.exists()) {
            totalMined = parseFloat(snapshot.val()) || 0;
            totalMinedUsdEl.innerText = totalMined.toFixed(4) + " $";
        } else {
            totalMined = 0;
            totalMinedUsdEl.innerText = "0.0000 $";
        }
    });
}


function loadInitialData() {
    get(child(dbRef, "users/" + deviceId)).then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            currentBalance = parseFloat(data.balance) || 0; 
            
            balanceValueEl.innerText = currentBalance.toFixed(6) + " usdt";
            progressValueEl.innerText = `${earnedSinceLastAd.toFixed(6)} / ${AD_TRIGGER_AMOUNT.toFixed(6)} USDT`;
            
            initializeAdsgram();
            listenForGlobalStats();
        } else {
            currentBalance = 0;
            saveBalanceToFirebase().then(() => {
                balanceValueEl.innerText = currentBalance.toFixed(6) + " usdt";
                initializeAdsgram();
                listenForGlobalStats();
            });
        }
    }).catch(error => {
        console.error("Initial data loading error:", error);
        balanceValueEl.innerText = "Error!";
    });
}

function saveBalanceToFirebase() {
    const newTotalBalance = currentBalance;
    const amountToAdd = earnedSinceLastAd;
    const newGlobalTotal = totalMined + amountToAdd;
    
    const updates = {};
    updates["users/" + deviceId + "/balance"] = newTotalBalance.toFixed(4); 
    updates["stats/total_mined_usd"] = newGlobalTotal.toFixed(4); 
    
    return update(dbRef, updates).then(() => {
        console.log(`Firebase updated. Balance: ${newTotalBalance.toFixed(4)}, Global Total: ${newGlobalTotal.toFixed(4)}`);
        totalMined = newGlobalTotal;
    }).catch(error => {
        console.error("Firebase saving error:", error);
    });
}

// Sahifa yuklanganda ma'lumotlarni yuklashni boshlash
window.onload = loadInitialData;

// Sahifani tark etishdan oldin online holatini o'chirish
window.onbeforeunload = function() {
    if (miningInterval) {
         set(ref(db, "online_users/" + deviceId), null);
    }
};

</script>


</body>
</html>
