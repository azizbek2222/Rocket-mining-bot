<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdraw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body { background: #1a1a2e; color: white; min-height: 100vh; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="p-6">
    <div class="max-w-md mx-auto">
        <div class="flex items-center mb-8">
            <button onclick="location.href='index.html'" class="text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 class="text-2xl font-bold ml-4">Withdraw TON</h1>
        </div>

        <div class="glass rounded-3xl p-6 mb-6 text-center">
            <p class="text-gray-400 text-sm mb-4">Mablag'ni olish uchun hamyonni ulang</p>
            <div id="ton-connect-button" class="flex justify-center"></div>
        </div>

        <div class="glass rounded-3xl p-6 space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase font-bold ml-1">Summa (TON)</label>
                <input id="amount" type="number" placeholder="Min: 0.01" step="0.001" 
                    class="w-full bg-black/20 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 transition-all text-xl font-bold">
            </div>

            <button id="withdrawBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black shadow-lg shadow-blue-900/20 transition-all active:scale-95 uppercase">
                Send Request
            </button>
            
            <p id="msg" class="text-center text-sm font-medium"></p>
        </div>

        <div class="mt-8 text-center text-gray-500 text-xs">
            <p>So'rovlar 24 soat ichida ko'rib chiqiladi.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
            authDomain: "user1111-c84a0.firebaseapp.com",
            databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
            projectId: "user1111-c84a0",
            storageBucket: "user1111-c84a0.firebasestorage.app",
            messagingSenderId: "901723757936",
            appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://azizbek2222.github.io/Rocket-mining-bot/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        function getUserId() {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) return "tg_" + window.Telegram.WebApp.initDataUnsafe.user.id;
            return localStorage.getItem('mining_uid');
        }

        const userId = getUserId();

        document.getElementById('withdrawBtn').onclick = async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const msg = document.getElementById('msg');
            
            if (!tonConnectUI.connected) {
                msg.innerText = "❌ Avval hamyonni ulang!";
                msg.className = "text-center text-red-400 font-medium";
                return;
            }

            if (isNaN(amount) || amount < 0.01) {
                msg.innerText = "❌ Minimal 0.01 TON bo'lishi kerak";
                msg.className = "text-center text-red-400 font-medium";
                return;
            }

            const userRef = ref(db, 'users/' + userId);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const balance = snapshot.val().balance || 0;
                if (balance < amount) {
                    msg.innerText = "❌ Balans yetarli emas!";
                    msg.className = "text-center text-red-400 font-medium";
                    return;
                }

                // Bazaga so'rov yuborish
                const requestRef = push(ref(db, 'withdraw_requests'));
                await set(requestRef, {
                    uid: userId,
                    address: tonConnectUI.account.address,
                    amount: amount,
                    status: 'pending',
                    date: new Date().toLocaleString()
                });

                // Balansni yangilash (ayirish)
                await update(userRef, { balance: balance - amount });
                
                msg.innerText = "✅ So'rov qabul qilindi!";
                msg.className = "text-center text-green-400 font-medium";
                document.getElementById('amount').value = "";
            }
        };
    </script>
</body>
</html>
