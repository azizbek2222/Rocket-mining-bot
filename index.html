<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta charset="UTF-8">
<title>rocket mining</title>

<style>
  
body {
        font-family: Arial, sans-serif;
        /* Asosiy fonni qora yoki tungi rangga o'zgartirish */
        background: #000022; /* Tungi koinot rangi */
        color: white; /* Matn rangini oq qilish */
        text-align: center;
        padding: 0;
        margin: 0;
        overflow: hidden; /* Scrollni oldini olish */
        min-height: 100vh;
        position: relative;
        padding-bottom: 70px; 
        background-attachment: fixed; 
    }

    /* Yulduzlar animatsiyasi uchun stil */
    .star-layer {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 0; /* Pastki fon bo'lishi uchun */
    }

    /* Kichik yulduzlar */
    .star-layer::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* Yulduzlar yaratish (radial-gradient, box-shadow kabi ishlaydi) */
        background: radial-gradient(2px 2px at 20px 30px, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
                    /* ... (Ko'proq yulduzlar) */
                    radial-gradient(1.5px 1.5px at 150px 180px, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 250px 200px, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 300px 100px, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 350px 250px, #fff, rgba(0,0,0,0)),
                    /* Yana kichik yulduzlar */
                    radial-gradient(1px 1px at 50% 50%, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 10% 70%, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 80% 10%, #fff, rgba(0,0,0,0)),
                    radial-gradient(1px 1px at 60% 85%, #fff, rgba(0,0,0,0));
                    
        /* Koinot fonini siljitish (Parallax effekti uchun sekin) */
        animation: starfield 100s linear infinite;
        background-size: 400px 400px; /* Yulduzlar takrorlanishi */
    }

    /* Kattaroq va tezroq harakatlanuvchi yulduzlar (chuqurlik effekti) */
    .star-layer::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(3px 3px at 40px 100px, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 120px 220px, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 200px 10px, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 300px 300px, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 10% 20%, #fff, rgba(0,0,0,0)),
                    radial-gradient(2px 2px at 90% 80%, #fff, rgba(0,0,0,0));

        /* Koinot fonini tezroq siljitish */
        animation: starfield 50s linear infinite reverse;
        background-size: 500px 500px;
    }

  body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #4e9fff, #6ac9ff);
        text-align: center;
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
        /* BOTTOM-NAV uchun joy qoldirish */
        padding-bottom: 70px; 
        /* Fon surilishini oldini oladi (avvalgi tuzatma) */
        background-attachment: fixed; 
    }
    
    /* === Yangi Joylashuvlar uchun Konteynerlar === */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 10px 15px;
        box-sizing: border-box;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        /* Fonga mos shaffoflik qo'shildi */
        background: rgba(78, 159, 255, 0.8); 
        backdrop-filter: blur(5px);
    }

    .balance-box {
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-block;
        text-align: left;
    }

    .balance-title {
        font-size: 14px;
        color: #666;
    }

    .balance-value {
        font-size: 20px;
        font-weight: bold;
        margin-top: 2px;
        color: #000;
    }
    
    /* Yuqoridagi tugmalar guruhi endi kerak emas, shuning uchun o'chiriladi yoki bo'sh qoladi. */
    /* .button-group block */

    /* Tugmalar endi PASTKI NAVIGATSIYA QISMIDA joylashadi */
    
    /* === Raketa Animatsiyasi Stili === */
    .main-content {
        /* Fixed top-bar uchun joy qoldirish */
        padding-top: 80px;
    }

    .rocket-container {
        position: relative;
        height: 250px; 
        margin: 20px auto;
        overflow: hidden; 
    }

    .rocket-image {
        width: 150px; 
        height: auto;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        transition: opacity 0.5s;
        z-index: 5;
    }

    .animating {
        animation: launch 5s ease-in-out infinite alternate;
    }
    
    /* === Bulutlar Stili === */
    .cloud {
        position: absolute;
        background: white;
        border-radius: 50%;
        opacity: 0.7;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        display: none;
    }

    .cloud1 { width: 80px; height: 30px; top: 180px; left: 10%; animation: floatCloud 20s linear infinite; z-index: 1; }
    .cloud2 { width: 120px; height: 40px; top: 150px; right: 5%; animation: floatCloud 15s linear infinite reverse; z-index: 1; }
    .cloud3 { width: 90px; height: 35px; top: 120px; left: 30%; animation: floatCloud 25s linear infinite; z-index: 1; }

    /* === Animatsiyalar (Original Raketa Animatsiyasi Qoldi) === */
    @keyframes launch {
        0% { 
            transform: translate(-50%, 0) rotate(0deg); 
            opacity: 1;
        }
        25% { 
            transform: translate(-50%, -50px) rotate(1deg); 
            opacity: 1;
        } 
        75% { 
            transform: translate(-50%, -100px) rotate(-1deg); 
            opacity: 1;
        }
        100% { 
            transform: translate(-50%, 0) rotate(0deg); 
        }
    }
    
    @keyframes floatCloud {
        0% { transform: translateX(0); }
        50% { transform: translateX(50px); }
        100% { transform: translateX(0); }
    }

    /* ================================== */
    
    /* === Launch Tugmasi Stili === */
    .main-btn {
        margin-top: 20px;
        padding: 14px 28px;
        background: linear-gradient(135deg, #007bff, #00a2ff);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        box-shadow: 0 4px 10px rgba(0,123,255,0.4);
        cursor: pointer;
    }

    /* === Status Bloklari Stili === */
    .status-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        width: 100%;
        max-width: 350px;
        margin: 20px auto 0;
    }

    .status-item {
        text-align: center;
        flex-basis: 45%;
    }

    .status-icon {
        width: 50px;
        height: 50px;
        margin-bottom: 5px;
        background-color: #f0f0f0; 
        border-radius: 5px;
        display: inline-block;
        line-height: 50px;
        font-size: 20px;
        color: #555;
    }

    .status-value {
        font-weight: bold;
        font-size: 16px;
        color: white;
        text-shadow: 0 0 3px #000;
    }

    .refill-btn {
        padding: 8px 15px;
        margin-top: 10px;
        background: #ff5722;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Qalqon va Yoqilg'i tugmalari 100% bo'lganda ko'rinmasligi uchun */
    .refill-btn.hidden {
        display: none;
    }
    
    /* === YANGI: PASTKI NAVIGATSIYA STILI === */
    .bottom-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        background: #fff; /* Oq fon */
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        padding: 5px 0;
        box-sizing: border-box;
        z-index: 20;
    }

    .bottom-nav button {
        flex-grow: 1;
        padding: 8px 5px;
        border: none;
        border-radius: 5px;
        font-size: 12px; /* Kichikroq shrift */
        font-weight: bold;
        transition: transform 0.2s;
        margin: 0 2px;
    }
    
    /* Pastki navigatsiya tugmalari ranglari */
    .withdraw-btn { background: #00c16e; color: white; }
    .tasks-btn { background: #ffaa00; color: white; }
    .referral-btn { background: #8A2BE2; color: white; }
    .leaderboard-btn { background: #FFD700; color: #333; }
    .games-btn { background: #FF5722; color: white; }

    /* Yuqoridagi games-btn ni olib tashlash kerak edi, lekin siz tegma deganingiz uchun uni pastki nav'ga moslashtiraman */
    .games-btn {
        position: static; /* Bu qoida endi pastki nav ichida ishlaydi */
        margin-top: 0;
    }



        /* === YANGI: CHAT TUGMASI STILI === */
    .chat-btn-container {
        position: absolute;
        right: 15px; /* O'ng burchakdan masofa */
        top: 10px; /* Yuqori burchakdan masofa, top-bar ichida joylashadi */
        z-index: 11; /* Boshqa elementlardan ustun turishi uchun */
    }
    
    .chat-btn {
        background: #FF5722; /* Yorqin to'q sariq rang */
        color: white;
        border: none;
        border-radius: 50%; /* Dumaloq shakl */
        width: 45px;
        height: 45px;
        font-size: 20px;
        line-height: 45px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(255,87,34,0.5);
        cursor: pointer;
        transition: transform 0.2s, background 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none; /* A tagi bo'lsa, chiziqni olib tashlash */
        font-weight: bold;
    }
    
    .chat-btn:hover {
        background: #e64a19;
        transform: scale(1.05);
    }
    
    /* Ikonka stili (Agar siz faqat M harfini ishlatsangiz, bu kerak emas. Agar rasm ishlatsangiz, o'zgartiring) */
    .chat-btn span {
        font-size: 22px;
        font-weight: bold;
    }


        /* === YANGI: YANGILASH TUGMASI STILI === */
    .refresh-btn {
        background: #4CAF50; /* Yashil rang */
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px; /* Kichikroq qilingan */
        height: 40px; /* Kichikroq qilingan */
        font-size: 18px;
        line-height: 40px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
        /* Faqat Flex item bo'lsa kerak */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .refresh-btn:hover {
        background: #45a049;
    }

    /* top-bar ichidagi joylashuvni boshqarish uchun */
    .top-bar {
        display: flex;
        justify-content: space-between; /* Elementlarni ikki chetga surish */
        align-items: center;
    }
    
    /* Tugmalar guruhini yaratish (ixtiyoriy, lekin tartibni yaxshilaydi) */
    .action-buttons {
        display: flex;
        gap: 10px; /* Tugmalar orasidagi masofa */
    }




</style>

</head>
<body>

<div class="top-bar">
    <div class="balance-box">
        <div class="balance-title">Balance</div>
        <div class="balance-value" id="balance">0 so'm</div>
    </div>
    
    <div class="action-buttons">
        <button class="refresh-btn" onclick="location.reload()">
            üîÑ
        </button>

        <div class="chat-btn-container" style="position: static;">
            <a href="chat.html" class="chat-btn">
                <span>üí¨</span> 
            </a>
        </div>
    </div>
    </div>



<div class="main-content">
    <div class="rocket-container">
        <div class="cloud cloud1" id="cloud1"></div>
        <div class="cloud cloud2" id="cloud2"></div>
        <div class="cloud cloud3" id="cloud3"></div>
        <img src="rocket.png" alt="Rocket Miner" class="rocket-image" id="rocket"> 
    </div>

    <div class="status-container">
        <div class="status-item">
            <img src="shield.png" alt="Shield" class="status-icon" style="background: none; width: 40px; height: 40px;"> 
            <div class="status-value" id="shield-value">0%</div> 
            <button class="refill-btn" id="shield-btn" onclick="getShield()">Qalqon oling</button>
        </div>

        <div class="status-item">
            <img src="fuel.png" alt="Fuel" class="status-icon" style="background: none; width: 40px; height: 40px;">
            <div class="status-value" id="fuel-value">0%</div> 
            <button class="refill-btn" id="fuel-btn" onclick="refuel()">Yoqilg'i quyish</button>
        </div>
    </div>
    <button class="main-btn" id="launch-btn" onclick="launchMiner()">raketa konchini uchirish</button>
</div>

<div class="bottom-nav">
    <button class="withdraw-btn" onclick="location.href='withdraw.html'">üí∞ pul yechish</button>
    <button class="tasks-btn" onclick="location.href='task.html'">‚úÖ vazifalar</button>
    <button class="referral-btn" onclick="location.href='referal.html'">üë• Referral</button>
    <button class="leaderboard-btn" onclick="location.href='reyting.html'">üèÜ Reyting</button>
    <button class="action-btn games-btn" onclick="location.href='index.html'">üéÆ soon</button>
</div>


<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

// === FIREBASE KONFIGURATSIYASI ===
const firebaseConfig = {
  apiKey: "AIzaSyDIeG8dVbm0Yk7FR1hPzrBoD7rgDKWAFoY",
  authDomain: "user1111-c84a0.firebaseapp.com",
  databaseURL: "https://user1111-c84a0-default-rtdb.firebaseio.com",
  projectId: "user1111-c84a0",
  storageBucket: "user1111-c84a0.firebaseapp.com",
  messagingSenderId: "901723757936",
  appId: "1:901723757936:web:9da0a1c7ec494f4a0c03b5",
  measurementId: "G-9R8ZQY63B1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);

let deviceId = localStorage.getItem("deviceId");
if(!deviceId){
    deviceId = "user_"+Math.random().toString(36).substr(2,9);
    localStorage.setItem("deviceId", deviceId);
}

let balance = 0;
let fuel = 0; 
let shield = 0;

const fuelValueEl = document.getElementById("fuel-value");
const shieldValueEl = document.getElementById("shield-value");
const fuelBtn = document.getElementById("fuel-btn");
const shieldBtn = document.getElementById("shield-btn");

const adBtn = document.getElementById("launch-btn");
const rocketImg = document.getElementById("rocket");
const clouds = [document.getElementById("cloud1"), document.getElementById("cloud2"), document.getElementById("cloud3")]; 
let remainingTime = 0;
const TIMER_SECONDS = 300; // 5 minut
// === O'ZGARTIRILGAN QATOR ===
const MINING_REWARD = 15.00; // 15 so'm
// =============================
const REWARD_PER_SECOND = MINING_REWARD / TIMER_SECONDS; 
const DECREMENT_RATE = 100 / TIMER_SECONDS; 

let AdController = null; 
let miningInterval = null; 
let referrerId = null; 

// === ADSGRAM/ADSONAR Funksiyalari (Refuel va Shield uchun) ===

function onRefillComplete(resource) {
    const refillAmount = 20; // Har safar 20% to'ldiriladi
    
    if (resource === 'fuel') {
        // Yoqilg'ini faqat 100% gacha to'ldirish
        fuel = Math.min(100, fuel + refillAmount);
        alert(`Yoqilg'i muvaffaqiyatli to'ldirildi. Hozirgi holat: ${Math.floor(fuel)}%`);
    } else if (resource === 'shield') {
        // Qalqonni faqat 100% gacha to'ldirish
        shield = Math.min(100, shield + refillAmount);
        alert(`Qalqon muvaffaqiyatli tiklandi. Hozirgi holat: ${Math.floor(shield)}%`);
    }
    
    updateStatus();
    // Reklama tugagandan so'ng darhol Firebase'ga yozish
    update(ref(db, "users/" + deviceId), { fuel: fuel, shield: shield });
}

function showRefillAd(resource) {
    // Agar allaqachon 100% bo'lsa, reklamani ko'rsatmaslik
    if ((resource === 'fuel' && fuel > 99.99) || (resource === 'shield' && shield > 99.99)) {
        alert(resource === 'fuel' ? "Yoqilg'i allaqachon 100% to'la." : "Qalqon allaqachon 100% tiklangan.");
        return;
    }

    if (window.Adsgram && AdController) {
        AdController.show().then(() => {
            onRefillComplete(resource);
        }).catch(err => { 
            console.error(err); 
            alert(`Reklama yuklanmadi yoki xatolik yuz berdi. Iltimos, qayta urinib ko'ring.`);
        });
    } else {
        alert("server yuklanmoqda....");
    }
}

// YANGI: Faqat kirishda avtomatik reklama ko'rsatish uchun funksiya
function showInterstitialAd() {
    if (window.Adsgram && AdController) {
        // Adsgram to'liq yuklanganini tasdiqlash uchun AdController.show() dan oldin
        // AdController.isReady() funksiyasi mavjud bo'lsa, foydalaniladi.
        // Agar mavjud bo'lmasa, to'g'ridan-to'g'ri ko'rsatishga harakat qilamiz.
        AdController.show().then(() => {
            console.log("Avtomatik to'liq ekranli reklama ko'rsatildi.");
        }).catch(err => { 
            console.error("Avtomatik reklama ko'rsatishda xatolik:", err);
            // Foydalanuvchi interfeysini to'sib qo'ymaslik uchun 'alert' ishlatilmaydi
        });
    }
}


window.refuel = function() {
    showRefillAd('fuel');
};

window.getShield = function() {
    showRefillAd('shield');
};
// =============================================================

// === LAUNCH MINER LOGIKASI (TUZATILGAN) ===
window.launchMiner = function() {
    if (remainingTime > 0) return; 
    
    // 1. Foizlarni tekshirish - Faqat aniq 100% bo'lgandagina ishga tushirilsin
    if (fuel < 99.99 || shield < 99.99) {
        let missing = [];
        if (fuel < 99.99) missing.push("Yoqilg'i (Fuel)");
        if (shield < 99.99) missing.push("Qalqon (Shield)");

        alert(`Raketani uchirish uchun ${missing.join(" va ")} 100% bo'lishi kerak. Iltimos, reklamani ko'rib to'ldiring.`);
        return;
    }
    
    // 2. Taymerni boshlash
    remainingTime = TIMER_SECONDS;
    startTimer();

    // 3. Ma'lumotlarni saqlash (Taymer boshlanganda)
    let lastLaunchTime = Date.now();
    
    // --- YANGI REYTING MANTIQI QO'SHILDI ---
    // Foydalanuvchining joriy ma'lumotlarini olish
    get(child(dbRef, "users/" + deviceId)).then(snapshot => {
        const userData = snapshot.val();
        // launchCount ni 1 taga oshirish
        const currentLaunchCount = userData ? (userData.launchCount || 0) : 0;
        const newLaunchCount = currentLaunchCount + 1;

        // isMining, lastLaunchTime va launchCount ni bir vaqtda yangilash
        update(ref(db, "users/" + deviceId), { 
            lastLaunchTime: lastLaunchTime, 
            isMining: true,
            launchCount: newLaunchCount // Reyting ballini saqlash
        });
        
        console.log(`Reyting hisoblandi: Launch Count: ${newLaunchCount}`);
    }).catch(error => {
        console.error("Launch Miner/Reyting hisoblashda xatolik:", error);
        // Agar Firebase'dan o'qishda xatolik bo'lsa, hech bo'lmasa asosiy ma'lumotlarni saqlaymiz.
        update(ref(db, "users/" + deviceId), { 
            lastLaunchTime: lastLaunchTime, 
            isMining: true
        });
    });
    // --- YANGI REYTING MANTIQI TUGADI ---
};
// =============================================================

function initializeAdsgram() {
    // AdsGram mavjudligini tekshirish
    if (window.Adsgram && !AdController) {
        AdController = window.Adsgram.init({blockId:"int-18645"});
        console.log("Adsgram muvaffaqiyatli ishga tushirildi.");
        
        // --- YANGI: ADSGRAM ISHGA TUSHGANDAN KEYIN 50s KUTISH MANTIQI ---
        setTimeout(() => {
            showInterstitialAd();
        }, 50000); 
        // --- YANGI MANTIQ TUGADI ---
        
    } else {
        // Agar birinchi urinishda ishga tushmasa, 1 soniyadan keyin qayta urinib ko'rish
        if (!AdController) {
             console.log("Adsgram yuklanmoqda...");
             setTimeout(initializeAdsgram, 1000); 
        }
    }
}

// Ilovani ishga tushirish (Firebase'dan ma'lumotlarni yuklash va AdsGramni initsializatsiya qilish)
function initApp() {
    // 1. Adsgramni ishga tushirishga urinish
    // Bu funksiya ichida endi 2 soniyadan keyin reklama chiqish mantiqi bor.
    initializeAdsgram();
    
    // REFERRAL MANTIQI: Telegram TWA dan start_param ni olish va uni global qilish
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
        const startParam = window.Telegram.WebApp.initDataUnsafe.start_param;
        // Agar startParam mavjud bo'lsa va u hozirgi foydalanuvchining ID si bo'lmasa, uni saqlaymiz
        if (startParam && startParam !== deviceId) {
            referrerId = startParam; 
            console.log("Referrer ID topildi:", referrerId);
        }
    }

    // 2. Firebase'dan ma'lumotlarni yuklash va davom ettirish mantiqi
    get(child(dbRef, "users/"+deviceId)).then(snapshot=>{
        if(snapshot.exists()){
            const data = snapshot.val();
            
            // FOIZLAR VA BALANSNI YUKLASH
            
            // === TUZATILGAN QATOR: Balansni yuklashda uni Raqamga (Number) aylantirish
            if(data.balance !== undefined) {
                 // Agar Firebase'da string sifatida saqlangan bo'lsa ham, uni raqamga aylantiramiz
                 balance = parseFloat(data.balance) || 0; 
            }
            // ===================================================================
            
            if(data.fuel !== undefined) fuel = data.fuel;
            if(data.shield !== undefined) shield = data.shield;
            
            // Agar foydalanuvchining referrerId ma'lumoti mavjud bo'lsa, uni ham saqlash
            // Faqat bir marta o'rnatish uchun: agar data.referrerId mavjud bo'lmasa va URL'dan olingan bo'lsa
            if(!data.referrerId && referrerId) {
                // Yangi topilgan referrerId'ni Firebase'ga saqlash
                update(ref(db, "users/" + deviceId), { referrerId: referrerId });
            } else if (data.referrerId) {
                 // Agar Firebase'da mavjud bo'lsa, uni ishlatish
                 referrerId = data.referrerId;
            }
            
            // === O'ZGARTIRILGAN QATOR ===
            document.getElementById("balance").innerText = balance.toFixed(2)+" so'm";
            // =============================
            updateStatus();
            
            // Mining jarayonini davom ettirish yoki tugatish mantiqi
            if(data.isMining && data.lastLaunchTime){
                const now = Date.now();
                const timeSinceLastLaunch = Math.floor((now - data.lastLaunchTime) / 1000); // Sekunddagi farq
                
                // Ilovaga kirguncha o'tgan haqiqiy mining vaqti:
                // Resurslar tugashini hisobga olgan holda maksimal vaqt.
                // Qalqon va Yoqilg'i qanchada tugashini sekundda hisoblash
                const maxDurationByFuel = fuel / DECREMENT_RATE;
                const maxDurationByShield = shield / DECREMENT_RATE;
                
                // O'tgan samarali mining vaqti
                // O'tgan vaqt, Yoqilg'i tugash vaqti va Qalqon tugash vaqtining eng kichigini olish
                const effectiveMiningTime = Math.min(timeSinceLastLaunch, maxDurationByFuel, maxDurationByShield);
                
                // Balans va foizlarni hisoblash
                if (effectiveMiningTime > 0) {
                    const earnedReward = effectiveMiningTime * REWARD_PER_SECOND;
                    balance += earnedReward;
                    
                    const decrementAmount = effectiveMiningTime * DECREMENT_RATE;
                    fuel = Math.max(0, fuel - decrementAmount);
                    shield = Math.max(0, shield - decrementAmount);

                    // YANGI MANTIQ QO'SHILDI: REFERRAL BONUSINI ASOSIY FOYDALANUVCHIGA HAM HISOBLASH
                    if (referrerId) {
                         const totalReferrerBonus = effectiveMiningTime * REWARD_PER_SECOND * 0.02; // 2%
                         
                         // REFERRER balansini yangilash
                         get(child(dbRef, "users/" + referrerId)).then(refSnapshot => {
                             if (refSnapshot.exists()) {
                                 const refData = refSnapshot.val();
                                 // Referral bonusini o'ziga xos maydonga qo'shish
                                 // Referral bonusini yuklashda ham parse qilish kerak bo'lishi mumkin
                                 const currentRefBonus = parseFloat(refData.referral_bonus) || 0;
                                 const newRefBonus = currentRefBonus + totalReferrerBonus;
                                 
                                 update(ref(db, "users/" + referrerId), { 
                                     // O'tgan vaqtdagi bonusni asosiy balansga qo'shmaslik, faqat referral_bonus maydoniga qo'shish
                                     referral_bonus: newRefBonus.toFixed(2)
                                 });
                             }
                         }).catch(error => {
                             console.error("Referrer bonusini yangilashda xatolik:", error);
                         });
                    }
                    
                }
                
                // Qolgan vaqtni resurslarning eng past foiziga qarab hisoblash
                // RemainingTime ni o'tgan vaqtdan keyingi holatiga qarab hisoblash
                const lowestResourcePercent = Math.min(fuel, shield);
                remainingTime = Math.max(0, Math.floor(lowestResourcePercent / DECREMENT_RATE)); 
                
                // Agar resurslar tugagan bo'lsa
                if (remainingTime <= 0) {
                    // Miningni to'xtatish va Firebase'ga yakuniy holatni yozish
                    fuel = 0;
                    shield = 0;
                    
                    // === O'ZGARTIRILGAN QATOR ===
                    document.getElementById("balance").innerText = balance.toFixed(2)+" so'm";
                    // =============================
                    updateStatus();
                    
                    // YANGI MANTIQ: lastLaunchTime ni ham yangilash - bu juda muhim!
                    update(ref(db, "users/" + deviceId), { 
                        balance: balance.toFixed(2), // Balansni string sifatida saqlash
                        fuel: 0, 
                        shield: 0, 
                        isMining: false, 
                        lastLaunchTime: Date.now() // Tugagan vaqtni yozib qo'yish
                    });
                    stopMining();
                    console.log("Resurslar tugadi. Mining to'xtatildi va Firebase yangilandi.");
                } else {
                    // Miningni davom ettirish
                    
                    // Balans va foizlarni yangilash
                    // === O'ZGARTIRILGAN QATOR ===
                    document.getElementById("balance").innerText = balance.toFixed(2)+" so'm";
                    // =============================
                    updateStatus();
                    
                    // YANGI MANTIQ: lastLaunchTime ni hozirgi vaqtga yangilash
                    // Bu, keyingi kirishda faqat shu vaqtdan boshlab hisoblashni ta'minlaydi.
                    update(ref(db, "users/" + deviceId), { 
                        balance: balance.toFixed(2), // Balansni string sifatida saqlash
                        fuel: fuel, 
                        shield: shield,
                        isMining: true,
                        lastLaunchTime: now
                    });
                    
                    startTimer(); // Taymerni qolgan vaqtdan davom ettirish
                    console.log(`Davom etish: Effective Mining Time: ${effectiveMiningTime}s. Qolgan vaqt: ${remainingTime}s.`);
                }
                
            }
        } else {
            // Yangi foydalanuvchi bo'lsa, 0% bilan saqlash
            const newUser_data = { fuel: 0, shield: 0, balance: "0.00", isMining: false, lastLaunchTime: Date.now() };
            
            if (referrerId) {
                 newUser_data.referrerId = referrerId;
            }
            
            update(ref(db, "users/" + deviceId), newUser_data);
            
            // Yangi foydalanuvchi uchun balans va foizlarni ekranda ko'rsatish
            // === O'ZGARTIRILGAN QATOR ===
            document.getElementById("balance").innerText = balance.toFixed(2)+" so'm";
            // =============================
            updateStatus();
        }
    }).catch(error => {
        console.error("Firebase'dan ma'lumotlarni yuklashda xatolik:", error);
    });
}

// Sahifa to'liq yuklanganda ilovani ishga tushirish
window.onload = initApp;


// === FOIZLARNI VA TUGMALARNI YANGILASH FUNKSIYASI (O'ZGARTIRILDI) ===
function updateStatus() {
    // Faqat butun sonni ko'rsatish
    fuelValueEl.innerText = `${Math.floor(fuel)}%`;
    shieldValueEl.innerText = `${Math.floor(shield)}%`;
    
    // Tugmalarni yashirish/ko'rsatish mantig'i: Faqat 100% dan past bo'lsa ko'rinadi
    // 99.99% dan past bo'lsa to'ldirish tugmasini ko'rsatish.
    // So'rov bo'yicha tahrirlandi: Endi 100% (yoki 99.99% dan yuqori) bo'lsa, tugma yashirinadi.
    
    if (fuel > 99.99) {
        fuelBtn.classList.add("hidden");
    } else {
        fuelBtn.classList.remove("hidden");
    }

    if (shield > 99.99) {
        shieldBtn.classList.add("hidden");
    } else {
        shieldBtn.classList.remove("hidden");
    }
}
// =======================================================

// === ANIMATSIYA VA TAYMER KODI ===
// (Bu kod sizning original kodingizdan olingan)

function toggleCloudVisibility(shouldShow) {
    clouds.forEach(cloud => {
        cloud.style.display = shouldShow ? 'block' : 'none';
    });
}

function toggleRocketAnimation(shouldAnimate) {
    if (shouldAnimate) {
        rocketImg.classList.add('animating');
        toggleCloudVisibility(true);
    } else {
        rocketImg.classList.remove('animating');
        toggleCloudVisibility(false);
    }
}

function stopMining() {
    clearInterval(miningInterval);
    miningInterval = null;
    toggleRocketAnimation(false);
    adBtn.innerText = "raketa konchini uchirish";
    remainingTime = 0; 
}

function updateMiningStatus() {
    // Har bir tsiklda tekshirish, shuningdek, Firebase'ga yangilanishni yuborishdan oldin ham
    if (remainingTime <= 0 || fuel <= 0 || shield <= 0) {
        // Yangilanishda firebasedagi isMining = false ga o'rnatiladi
        stopMining(); 
        
        // YANGI MANTIQ: Mining to'xtaganidan keyin yakuniy holatni Firebase'ga saqlash
        update(ref(db, "users/" + deviceId), { 
            isMining: false, 
            fuel: Math.max(0, fuel), 
            shield: Math.max(0, shield),
            balance: balance.toFixed(2), // Pulni 2 xonali aniqlikda saqlash (string)
            lastLaunchTime: Date.now() // Tugagan vaqtni yozish
        });
        return;
    }

    // 1. Balansni hisoblash va yangilash
    balance += REWARD_PER_SECOND;
    // === O'ZGARTIRILGAN QATOR ===
    document.getElementById("balance").innerText = balance.toFixed(2)+" so'm";
    // =============================
    
    // 2. Foizlarni kamaytirish
    fuel -= DECREMENT_RATE;
    shield -= DECREMENT_RATE;
    
    // 3. Taymerni kamaytirish
    remainingTime--;
    
    // 4. Ekranni yangilash
    updateStatus();

    // 5. Tugmani vaqtni ko'rsatishga yangilash
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    const pad = (num) => String(num).padStart(2, '0');
    adBtn.innerText = `Mining: ${pad(minutes)}:${pad(seconds)}`;

    // YANGI MANTIQ: Har 10 ta yangilanishda (10 sekundda) Firebase'ga yozish
    if (remainingTime % 10 === 0) {
        update(ref(db, "users/" + deviceId), { 
            fuel: fuel, 
            shield: shield,
            balance: balance.toFixed(2), // Balansni string sifatida saqlash
            //lastLaunchTime ni yangilamaslik (bu faqat start yoki stop da kerak)
        });
        console.log(`Firebase yangilandi: qolgan vaqt: ${remainingTime}`);
    }
}

function startTimer() {
    if (miningInterval) clearInterval(miningInterval);
    
    toggleRocketAnimation(true);
    updateMiningStatus(); // Birinchi marta darhol yangilash

    // Har bir sekundda yangilash
    miningInterval = setInterval(() => {
        updateMiningStatus();
    }, 1000);
}

// =======================================================


</script>


</body>
</html>